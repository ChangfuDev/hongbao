# 数据一致性问题

经测试，在并发条件下抢红包，会导致库存的数量变成负数（这是高并发下的超发现象）


## 解决方案

### 悲观锁

也称独占锁，只能一个线程持有锁

利用数据库内部机制提供的锁，对更新的数据加锁

#### 实现
- 在SQL语句中加入 `for update`
    - 主键查询，会对行加锁
    - 如果使用非主键查询，要考虑是否对全表加锁的问题，加锁后可能会引发其他查询的阻塞

##### 缺点
- 性能不佳

### 乐观锁

一种不会阻塞其他线程的机制

#### 实现
- CAS原理
    - 加入版本号，防止ABA问题
    
    
##### 缺点
- 失败率有点高
